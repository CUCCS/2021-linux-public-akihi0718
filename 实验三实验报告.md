# 实验3——实验报告

## 实验目的

- 实践systemd相关命令
- 熟悉守护进程启动的相关知识

## 实验环境

- 虚拟机：VitualBox
- Ubuntu20.04 Service

## 动手实践systemd

### 1、命令篇

命令篇1

[![asciicast](https://asciinema.org/a/IhHg6c7846PgVGE1fsZtvrO8a.svg)](https://asciinema.org/a/IhHg6c7846PgVGE1fsZtvrO8a)

命令篇2

[![asciicast](https://asciinema.org/a/ZWVIqHol84Hv7NeAUnOeqx38m.svg)](https://asciinema.org/a/ZWVIqHol84Hv7NeAUnOeqx38m)

命令篇3

[![asciicast](https://asciinema.org/a/xNzmP4rUBDVZBzL4VLBPjX2NY.svg)](https://asciinema.org/a/xNzmP4rUBDVZBzL4VLBPjX2NY)

### 2、实战篇

[![asciicast](https://asciinema.org/a/moxBRuU1rK7ImCPRE2WPQsfov.svg)](https://asciinema.org/a/moxBRuU1rK7ImCPRE2WPQsfov)

## 自查清单

#### 1、如何添加一个用户并使其具备sudo执行程序的权限？

- 添加用户：adduser username
- 将username添加到sudo组：sudo adduser username sudo

#### 2、如何将一个用户添加到一个用户组？

- sudo adduser username groupname
- sudo usermod -a username -G groupname

#### 3、如何查看当前系统的分区表和文件系统详细信息？

- 查看系统分区表：

  - sudo sfdisk -l 

  - sudo cfdisk

  - df -ah

  - lsblk -a

  - cat /proc/partitions

- 查看文件系统详细信息：df -a

#### 4、如何实现开机自动挂载Virtualbox的共享目录分区？

- 在Virtualbox的共享文件夹添加共享的本地文件TEST，勾选自动挂载和固定分配
- apt install virtualbox-guest-utils:使之含有mount.vbocsf文件
- sudo mkdir /mnt/share：创建ubuntu中用于共享的文件目录
- sudo mount -t vboxsf TEST /mnt/share：将本地共享文件夹挂载到指定目录
- 在/etc/rc.local中追加mount -t vboxsf TEST /mnt/share：实现开机自动挂载

#### 5、基于LVM（逻辑分卷管理）的分区如何实现动态扩容和缩减容量？

```linux
#缩容
lvreduce -L -size /dev/dir
#扩容
lvextend -L +size /dev/dir
```

#### 6、如何通过systemd设置实现在网络连通时运行一个指定脚本，在网络断开时运行另一个脚本？

- 在/usr/lib/systemd/system建立在网络连通时运行指定脚本的配置文件

  ```linux
  [Unit] 
  Description=network up run scriptA 
  After=network.target network-online.target network-re.target #在网络服务连通后运行脚本（即网络连通时） 
  
  [Service] 
  Type=oneshot #执行一次 
  ExecStart=MY_SCRIPTA_PATH #运行脚本A位置  
  
  [Install] 
  WantedBy=multi-user.target #多用户模式
  ```

- 在/usr/lib/systemd/system建立在网络断开时运行指定脚本的配置文件

  ```linux
  [Unit] 
  Description=network down run scriptB 
  Before=network.target network-online.target network-pre.target #在网络服务连通前运行脚本（即网络断开时） 
  
  [Service] 
  Type=oneshot #执行一次 
  ExecStart=MY_SCRIPTB_PATH #运行脚本B位置  
  
  [Install] 
  WantedBy=multi-user.target #多用户模式
  ```

#### 7、如何通过systemd设置实现一个脚本在任何情况下被杀死之后会立即重新启动？实现杀不死？

- 在/usr/lib/systemd/system建立运行指定脚本的配置文件SCRIPT

  ```linux
  [Unit] 
  Description=Script  
  
  [Service] 
  Type=forking 
  ExecStart=SCRIPT_PATH 
  ExecStop=SCRIPT_PATH 
  Restart=always 
  RestartSec=1 
  RemainAfterExit=yes  
  
  [Install] 
  WantedBy=multi-user.target
  ```

- 重新加载配置文件，重启相关服务

  ```linux
  #重新加载配置文件
  sudo systemctl daemon-reload
  #重启相关服务
  sudo systemctl restart servicename
  ```

## 参考资料

- [Systemd 入门教程：命令篇 by 阮一峰的网络日志]

  http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html

- [Systemd 入门教程：实战篇 by 阮一峰的网络日志]

  http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html

- [CUCCS/linux-2020-kate123wong]

  https://github.com/CUCCS/linux-2020-kate123wong/blob/chap0x03/chap0x03/%E6%8A%A5%E5%91%8A.md

